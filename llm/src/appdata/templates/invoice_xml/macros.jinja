{# ADJUSTMENT #}
{% macro render_adjustment(adjustment) %}
<adjustment
{%- if adjustment.group_code %}
 group="{{ adjustment.group_code }}"
{%- endif %}
{%- if adjustment.reason_code %}
 carc="{{ adjustment.reason_code }}"
{%- endif %}
{%- if adjustment.amount %}
 amount="${{ "%0.2f" | format(adjustment.amount | float) }}"
{%- endif %}
{%- if adjustment.responsibility %}
 responsibility="{{ adjustment.responsibility }}"
{%- endif %}
>
{% if adjustment.group_code_description %}
    <group_code_description>{{ adjustment.group_code_description }}</group_code_description>
{% endif  %}
{% if adjustment.reason_code_description %}
    <carc_description>{{ adjustment.reason_code_description }}</carc_description>
{% endif %}
{% if adjustment.guidance %}
    <patient_action>{{ adjustment.guidance.patient_action }}</patient_action>
{% endif %}
</adjustment>
{% endmacro %}
{# / ADJUSTMENT #}

{# PAYMENT #}
{% macro render_payment(payment) %}
<payment>
    <payment_status>{{ payment.payment_status }}</payment_status>
    <payment_amount>{{ payment.payment_amount }}</payment_amount>
    <payment_method>{{ payment.payment_method }}</payment_method>
    <transaction_date>{{ payment.transaction_date }}</transaction_date>
</payment>
{% endmacro %}
{# / PAYMENT #}

{# SERVICE #}
{% macro render_service(service, render_adjustments=true) %}
<service>
{% if service.service_date %}
    <date_of_service>{{ service.service_date }}</date_of_service>
{% endif %}
{% if not service.service_date %}
{% if service.service_period_start %}
    <service_period_start>{{ service.service_period_start }}</service_period_start>
{% endif %}
{% if service.service_period_end %}
    <service_period_end>{{ service.service_period_end }}</service_period_end>
{% endif %}
{% endif %}
{% if service.service_code %}
    <code>{{ service.service_code }}</code>
{% endif %}
{% if service.service_charge_amount %}
    <charge>${{ "%0.2f" | format(service.service_charge_amount | float) }}</charge>
{% endif %}
{% if service.service_allowed_amount %}
    <allowed>${{ "%0.2f" | format(service.service_allowed_amount | float) }}</allowed>
{% endif %}
{% if service.service_paid_amount %}
    <paid>${{ "%0.2f" | format(service.service_paid_amount | float) }}</paid>
{% endif %}
{% if service.service_balance %}
    <balance>${{ "%0.2f" | format(service.service_balance | float) }}</balance>
{% endif %}
{% if render_adjustments is sameas true and service.adjustments %}
    <adjustments>
{% for adjustment in service.adjustments -%}
{{ render_adjustment(adjustment) | indent(8, first=true) }}
{%- endfor %}
    </adjustments>
{% endif %}
</service>
{% endmacro %}
{# / SERVICE #}

{# CLAIM 835 #}
{% macro render_835(claim_835, render_services=true, render_adjustments=true) %}
<remittance
{%- if claim_835.status %}
{%- if claim_835.status.payer_classification %}
 payer_classification="{{ claim_835.status.payer_classification }}"
{%- endif %}
{%- if claim_835.status.description  %}
 status="{{ claim_835.status.description }}"
{%- endif  %}
{%- endif %}
>
{% if claim_835.rendering_provider %}
    <rendering_provider>{{ claim_835.rendering_provider.first_name | lower | capitalize }} {{ claim_835.rendering_provider.last_name | lower | capitalize }}</rendering_provider>
{% endif %}
{% if claim_835.total_charge_amount %}
    <total_charge>${{ "%0.2f" | format(claim_835.total_charge_amount | float) }}</total_charge>
{% endif %}
{% if claim_835.total_allowed_amount %}
    <total_allowed>${{ "%0.2f" | format(claim_835.total_allowed_amount | float) }}</total_allowed>
{% endif %}
{% if claim_835.total_paid_amount %}
    <total_paid>${{ "%0.2f" | format(claim_835.total_paid_amount | float) }}</total_paid>
{% endif %}
{% if claim_835.total_balance %}
    <total_balance>${{ "%0.2f" | format(claim_835.total_balance | float) }}</total_balance>
{% endif %}
{% if render_services is sameas true and claim_835.services %}
    <services>
{% for service in claim_835.services -%}
    {{ render_service(service, render_adjustments) | indent(8, first=true) }}
{%- endfor %}
{% endif %}
    </services>
</remittance>
{% endmacro %}
{# / CLAIM 835 #}

{# CLAIM #}
{% macro render_claim(claim, render_services=true, render_adjustments=true) %}
<claim>
{% if claim.date_of_service and not claim.date_of_service.lower() == 'none'%}
    <date_of_service>{{ claim.date_of_service }}</date_of_service>
{% endif %}
{% if claim.total_due is not sameas none %}
    <total_due>${{ "%0.2f" | format(claim.total_due | float) }}</total_due>
{% endif %}
{% if claim.total_fee is not sameas none %}
    <total_charge>${{ "%0.2f" | format(claim.total_fee | float) }}</total_charge>
{% endif %}
{% if claim.total_fee is not sameas none and claim.total_network_discount is not sameas none %}
    <total_allowed>${{ "%0.2f" | format(claim.total_fee - claim.total_network_discount | float) }}</total_allowed>
{% endif %}
{% if claim.total_network_discount is not sameas none %}
    <total_network_discount>${{ "%0.2f" | format(claim.total_network_discount | float) }}</total_network_discount>
{% endif %}
{% if claim.total_insurance is not sameas none%}
    <total_insurance_paid>${{ "%0.2f" | format(claim.total_insurance | float) }}</total_insurance_paid>
{% endif %}
{% if claim.total_manual_paid is not sameas none %}
    <total_manual_paid>${{ "%0.2f" | format(claim.total_manual_paid | float) }}</total_manual_paid>
{% endif %}
{% if claim.edi_mappings %}
    <remittances>
{% for claim_835 in claim.edi_mappings %}
{{ render_835(claim_835, render_services, render_adjustments) | indent(8, first=true) }}
{%- endfor %}
    </remittances>
{% endif %}
{%- if claim.adjustments and not claim.has_service_level_adjustments %}
    <adjustments>
{% for adjustment in claim.adjustments -%}
    {{- render_adjustment(adjustment) | indent(8, first=true) -}}
{% endfor %}
    </adjustments>
{% endif %}
</claim>
{% endmacro %}
{# / CLAIM #}

{# INVOICE #}
{% macro render_invoice(invoice, render_patient=true, render_practice=true, render_payments=true, render_services=true, render_adjustments=true) %}
<invoice>
{% if render_patient is sameas true and invoice.patient %}
    <patient>
        <first_name>{{ invoice.patient.first_name }}</first_name>
        <last_name>{{ invoice.patient.last_name }}</last_name>
    </patient>
{% endif %}
{% if render_practice is sameas true and invoice.practice %}
    <practice>
        <name>{{ invoice.practice.name }}</name>
    </practice>
{% endif %}
    <summary>
{% if invoice.total_fee != None %}
        <total_charged>${{ "%0.2f" | format(invoice.total_fee | float) }}</total_charged>
{% endif %}
{% if invoice.total_due != None %}
        <total_due>${{ "%0.2f" | format(invoice.total_due | float) }}</total_due>
{% endif %}
{% if invoice.total_network_discount != None %}
        <total_network_discount>${{ "%0.2f" | format(invoice.total_network_discount | float) }}</total_network_discount>
{% endif %}
{% if invoice.total_paid != None %}
        <total_non_insurance_paid>${{ "%0.2f" | format(invoice.total_paid | float) }}</total_non_insurance_paid>
{% endif %}
{% if invoice.total_insurance != None %}
        <total_insurance_paid>${{ "%0.2f" | format(invoice.total_insurance_paid | float) }}</total_insurance_paid>
{% endif %}
    </summary>
{% if invoice.claims %}
    <claims>
{% for claim in invoice.claims %}
{{ render_claim(claim, render_services, render_adjustments) | indent(8, first=true) }}
{%- endfor %}
    </claims>
{% endif %}
</invoice>
{% endmacro %}
{# / INVOICE #}